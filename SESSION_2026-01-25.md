# Session 16 - January 25, 2026

## Summary
Added `bestScore` attribute to BoardState for tracking minimum score along search path, added `-sb` (steps back) command line option for score-based pruning, and modified StateProcessor to prune states that drift too far from the best score.

## Changes Made

### 1. BoardState bestScore Attribute (`BoardState.java`)

**Added `bestScore` field to track minimum score along the search path**:
- New `private final int bestScore` field
- For initial state: `bestScore = board.getScore()`
- For successor states: `bestScore = Math.min(newBoard.getScore(), parent.bestScore)`
- Added `getBestScore()` getter method
- Updated `toString()` to include "Best score: N"

```java
// In applyMove()
int newBestScore = Math.min(newBoard.getScore(), this.bestScore);
BoardState newState = new BoardState(newBoard, move, remainingMoves - 1, newBestScore);
```

**Design rationale**: The bestScore tracks the lowest (best) board score seen along the path from initial state to current state. This enables pruning states that have drifted too far from their best score, indicating they're unlikely to lead to a solution.

### 2. Steps Back Command Line Option (`HarmonySolver.java`)

**Added `-sb <N>` command line option**:
- New `DEFAULT_STEPS_BACK = 1` constant
- New `stepsBack` field in Config class
- Parsing logic for `-sb <N>` argument (validates non-negative)
- New `getStepsBack()` getter method
- Updated usage message and configuration header display

```bash
# Usage
./solve.sh -sb 2 puzzle.txt    # Allow score to increase by 2 from best
./solve.sh -sb 0 puzzle.txt    # Strict: never allow score to increase
./solve.sh -sb 5 puzzle.txt    # Relaxed: allow more exploration
```

### 3. StateProcessor stepsBack Pruning (`StateProcessor.java`)

**Added stepsBack-based pruning in storeBoardStates()**:
- New `private final int stepsBack` field
- Updated constructors to accept `stepsBack` parameter
- In normal logic section of `storeBoardStates()`:
  - States with `boardScore > bestScore + stepsBack` are discarded
  - Discarded states counted as pruned via `pendingStates.addStatesPruned()`

```java
// In storeBoardStates() - normal logic section
if (boardScore > bestScore + stepsBack) {
    prunedByStepsBack++;
    continue;  // Discard state
}
```

**Effect**: Prevents exploration of states that have drifted too far from the best score seen on their path. This reduces search space while still allowing some "uphill" exploration.

### 4. StateSerializer bestScore Persistence (`StateSerializer.java`)

**Updated state file format to include bestScore**:
- New format: `bestScore:move1 move2 move3...`
- Example: `38:A1-A2 B1-B3 C2-C4`
- Backward compatible: files without bestScore prefix still parse correctly
- Updated `saveStates()` to write bestScore prefix
- Updated `loadStates()` to parse bestScore prefix
- Updated `reconstructState()` signature to accept `savedBestScore`

**State file format**:
```
# Harmony State File
# States: 262

38:A1-A2
37:C1-C2
36:C1-C4 A2-B2
...
```

## Files Modified

| File | Changes |
|------|---------|
| `BoardState.java` | Added bestScore field, getter, updated constructors and applyMove() |
| `HarmonySolver.java` | Added -sb option, stepsBack in Config, getStepsBack(), updated constructor call |
| `StateProcessor.java` | Added stepsBack field, updated constructors, pruning in storeBoardStates() |
| `StateSerializer.java` | Updated format to include bestScore prefix, backward compatible parsing |

## Testing

All puzzles solve correctly with the new features:

| Puzzle | Size | Score | Moves | -sb | Result | Processed | Pruned |
|--------|------|-------|-------|-----|--------|-----------|--------|
| tiny.txt | 2x2 | 6 | 4 | 1 | Solved | 4 | 0% |
| easy.txt | 2x2 | 4 | 3 | 2 | Solved | 5 | 0% |
| 3x3_8moves.txt | 3x3 | 9 | 8 | 1 | Solved | 30 | 51.5% |
| 3x3_12moves.txt | 3x3 | 19 | 12 | 2 | Solved | 21 | 30.4% |
| 4x4_9moves.txt | 4x4 | 7 | 9 | 1 | Solved | 58 | 42.3% |
| simple.txt | 3x3 | 6 | 9 | 2 | Solved | 613 | 42.5% |
| gen5-5.txt | 5x5 | 10 | 6 | 2 | Solved | 8 | 30.8% |

State persistence verified:
- State file correctly includes bestScore prefix
- Resume from state file works correctly

## Design Rationale

### Why bestScore?
The board score heuristic measures "distance from solution" (lower = better). During search, a state's score may temporarily increase before decreasing again toward the solution. The `bestScore` tracks the minimum score seen along the path, providing a baseline for pruning.

### Why stepsBack Pruning?
If a state's current score is much higher than the best score seen on its path, it's likely exploring a dead end. The `-sb` parameter controls how much "uphill" exploration is allowed:
- `-sb 0`: Strict - only allow score to stay same or decrease
- `-sb 1`: Default - allow score to increase by 1 from best
- `-sb 5+`: Relaxed - allow more exploration for complex puzzles

### Trade-offs
- **Lower stepsBack**: More aggressive pruning, faster but may miss solutions
- **Higher stepsBack**: Less pruning, slower but more thorough search
- **Default (1)**: Good balance for most puzzles

## Command Line Options (Updated)

```bash
./solve.sh [options] <puzzle-file>

Options:
  -t, --threads <N>     Number of worker threads (default: 2)
  -r, --report <N>      Progress report interval in seconds (default: 30, 0 to disable)
  -c, --cache <N>       Cache threshold: states with board score >= N are cached locally (default: 4)
  -sb <N>               Steps back: max score increase from best score before pruning (default: 1)
  -repl <N>             Replication factor for queue distribution (default: 3)
  -dur, --duration <N>  Run duration with optional unit suffix (default: 120m)
  -d, --debug           Debug mode: disable empty queue termination
  -i, --invalidity      Show invalidity test statistics instead of queue sizes
  --smallestFirst       Process moves with smallest tile sum first
  --largestFirst        Process moves with largest tile sum first
  -h, --help            Show this help message
```
